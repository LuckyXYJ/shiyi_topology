# 5种IO模型

Linux中总共分为5中IO模型:

1. 同步阻塞IO
2. 同步非阻塞IO
3. IO多路复用
4. 信号驱动IO
5. 异步IO



**IO是什么**

IO指的是，Input and Output，输入和输出设备。

要理解IO，先要了解两个概念:

1. Socket 
2. 缓冲区

### Socket

socket 是Linux中的套接字，是计算机网络中进程间进行双向通信的端点的抽象。一个 Socket 代表了网络通信的一端，是由操作系统提供的进程间通信机制。

- 在操作系统中，通常会为应用程序提供一组应用程序接口，称为 Socket 接口（Socket API）。应用程序可以通过 Socket 接口，来使用网络 Socket，以进行数据的传输。
- 一个 Socket 由IP地址和端口组成，即：Socket 地址 = IP地址 : 端口号。
- 在同一台计算机上，TCP 协议与 UDP 协议可以同时使用相同的端口（Port），而互不干扰。
- 要想实现网络通信，至少需要一对 Socket，其中一个运行在客户端，称之为 Client Socket；另一个运行在服务器端，称之为 Server Socket。
- Socket 之间的连接过程可以分为三个步骤：（1）服务器监听；（2）客户端连接；（3）连接确认。

![Socket](http://java-engineer.ztianzeng.com/uPic/1460000039898782.png)

### 缓冲区

每个 Socket 被创建后，都会在内核中分配两个缓冲区：输入缓冲区和输出缓冲区。

- 通过 Socket 发送数据并不会立即向网络中传输数据，而是先将数据写入到输出缓冲区中，再由 TCP 协议将数据从输出缓冲区发送到目标主机。

- 通过 Socket 接收数据也是如此，也是从输入缓冲区中读取数据，而不是直接从网络中读取。

  ![Socket缓冲区](http://java-engineer.ztianzeng.com/uPic/1460000039898783.png)

就好比，电话。

一头在讲，一头在听，socket套接字就相当于你的耳朵，用于监听其他小伙伴的请求。一旦建立上连接，就可以进行通讯。

而那个电话机，与传统电话不同，多了一个缓冲区的功能，能够暂时保存对方的话。

而这部电话很有特点，接通了就不讲话，就是玩。

![image-20210924170048865](http://java-engineer.ztianzeng.com/uPic/image-20210924170048865.png)

了解概念之后，来理解IO模型就比较容易了。

### 阻塞IO

相当于，小蓝从听筒中监听数据，因为不知道小红啥时候说话，为了避免错过信息，因此需要时时刻刻的监听着不能离开。

**用术语来说就是**

> 阻塞IO就是当应用发起读取数据申请时，在内核数据没有准备好之前，应用会一直处于等待数据状态，直到内核把数据准备好了交给应用才结束。
>
> 在应用调用recvfrom读取数据时，其系统调用直到数据包到达且被复制到应用缓冲区中或者发送错误时才返回，在此期间一直会等待，进程从调用到返回这段时间内都是被阻塞的称为阻塞IO；

**流程：**

1、应用进程向内核发起recfrom读取数据。

2、准备数据报（应用进程阻塞）。

3、将数据从内核负责到应用空间。

4、复制完成后，返回成功提示。



![阻塞式 IO 模型](http://java-engineer.ztianzeng.com/uPic/1460000039898785.png)

### 非阻塞IO

如果能看懂上面小红和小蓝的聊天模式，就能比较容易理解非阻塞IO。

小蓝不知道小红啥时候说话，但是呢却又不想错过他说的话，恰巧有个缓冲区，可以保留一下小红说的话，所以呢一会回来听一下，一会回来听一下，直到收到的小红的声音。

> 非阻塞IO就是当应用发起读取数据申请时，如果内核数据没有准备好会即刻告诉应用，不会让应用在这里等待。
>
> **术语**：非阻塞IO是在应用调用recvfrom读取数据时，如果该缓冲区没有数据的话，就会直接返回一个EWOULDBLOCK错误，不会让应用一直等待中。在没有数据的时候会即刻返回错误标识，那也意味着如果应用要读取数据就需要不断的调用recvfrom请求，直到读取到它数据要的数据为止。

**流程：**

1、应用进程向内核发起recvfrom读取数据。

2、没有数据报准备好，即刻返回EWOULDBLOCK错误码。

3、应用进程向内核发起recvfrom读取数据。

4、已有数据包准备好就进行一下 步骤，否则还是返回错误码。

5、将数据从内核拷贝到用户空间。

6、完成后，返回成功提示。

![非阻塞式 IO 模型](http://java-engineer.ztianzeng.com/uPic/1460000039898786.png)

### IO多路复用

小蓝的朋友特别多，每个人呢都有和小蓝通话的机会，但是小蓝只有一个耳朵，同时只能够监听一个人的电话进来，这个时候怎么办呢？

请秘书，让秘书去，那个秘书就是下面说的Select。秘书挨个去听，听到电话里面有声音之后，在通知小蓝进行处理。

![image-20210924170552263](http://java-engineer.ztianzeng.com/uPic/image-20210924170552263.png)

>  将多个应用进程的 Socket 注册到一个 Select（多路复用器）上，然后使用一个进程来监听该 Select（该操作会阻塞），Select 会监听所有注册进来的 Socket。只要有一个 Socket 的数据准备好，就会返回该Socket。再由应用进程发起 IO 系统调用，来完成数据读取。

![IO 多路复用模型](http://java-engineer.ztianzeng.com/uPic/1460000039898787.png)



### 信号驱动IO模型

这个时候，秘书感觉好累啊，这帮子人占着电话线，就是不说话，还不得不一个一个去听，效率太低了。得想个法子。

秘书改造了电话机。在对方话说完的时候，向她发送了一条短信。收到短信之后，再去听电话，再转交给小蓝。

>  可以为 Socket 开启信号驱动 IO 功能，应用进程需向内核注册一个信号处理程序，该操作并立即返回。当内核中有数据准备好，会发送一个信号给应用进程，应用进程便可以在信号处理程序中发起 IO 系统调用，来完成数据读取了。

![信号驱动 IO 模型](http://java-engineer.ztianzeng.com/uPic/1460000039898788.png)

### 异步IO

小蓝觉得这样效率太低了，秘书天天转发还拿那么多工资。于是把秘书辞退了。自己来。

小蓝也厉害，把电话机改成了人工智能的，和他说我要听电话，过一会就把对方说的话打印在纸上了。直接看纸就行。

> 应用进程发起 IO 系统调用后，会立即返回。当内核中数据完全准备后，并且也复制到了用户空间，会产生一个信号来通知应用进程。

![异步 IO 模型](http://java-engineer.ztianzeng.com/uPic/1460000039898789.png)

**从上述五种 IO 模型可以看出，应用进程对内核发起 IO 系统调用后，内核会经过两个阶段来完成数据的传输：**

- 第一阶段：等待数据。即应用进程发起 IO 系统调用后，会一直等待数据；当有数据传入服务器，会将数据放入内核空间，此时数据准备好。
- 第二阶段：将数据从内核空间复制到用户空间，并返回给应用程序成功标识。

![五种 IO 模型对比](https://segmentfault.com/img/remote/1460000039898790)

前四种模型的第二阶段是相同的，都是处于阻塞状态，其主要区别在第一阶段。而异步 IO 模型则不同，应用进程在这两个阶段是完全不阻塞的。

| IO 模型      | 第一阶段       | 第二阶段 |
| ------------ | -------------- | -------- |
| 阻塞式IO     | 阻塞           | 阻塞     |
| 非阻塞式IO   | 非阻塞         | 阻塞     |
| IO多路程复用 | 阻塞（Select） | 阻塞     |
| 信号驱动式IO | 异步           | 阻塞     |
| 异步IO       | 异步           | 异步     |





参考: https://segmentfault.com/a/1190000039898780